---
title: "Chelsea's Quarto"
author: "Chelsea Sanford"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(here)
library(sf)
library(terra)
library(tidyterra)
library(dplyr)
```

### Load in the Data

```{r}
groundwater_depth <- read_csv(here('data/groundwater_depth.csv'))
ca_counties_raw_sf <- read_sf(here("data/ca_counties/CA_Counties_TIGER2016.shp"))
water_quality <- read_csv(here('data/water_quality.csv'))

socioecodata <- read.csv(here('data/socioeco.csv'))
demodata <- read_csv(here('data/demodata.csv')) 
```

### Cut, clean, and rewrite data

```{r}
# ### demographic data
# demodata <- read.csv(here('data/demodata.csv')) 
# 
# first_row <- demodata[1, ] 
# colnames(demodata) <- as.character(first_row)
# 
# demodatamod <- demodata %>% 
#   janitor::clean_names() %>% 
#   filter(row_number() > 1) %>% 
#   select(-census_tract, -children_10_years_percent, -pop_10_64_years_percent, -elderly_64_years_percent)
# 
# write_csv(demodatamod, here('data/demodata.csv'))
# 
# ### Socioeconomic data
# socioecodata <- read.csv(here('data/cal_enviro_data.csv')) %>% 
#   janitor::clean_names() %>% 
#  select(california_county, longitude, latitude,ces_4_0_score, ces_4_0_percentile, ces_4_0_percentile_range, # drinking_water, drinking_water_pctl, lead, lead_pctl, poverty, poverty_pctl)
# 
# write_csv(socioecodata, here('data/socioeco.csv'))

## group_by() and select() are in both dplyr and terra
```

############################################## CES + County Data

### Edit the CES data

```{r}
ca_county_ces <- demodata %>% 
  drop_na() %>%   
  dplyr::group_by(california_county) %>% 
  summarize(avg_pctl = mean(ces_4_0_percentile, na.rm = TRUE),
            avg_score = mean(ces_4_0_score,na.rm = TRUE)) 

colnames(ca_county_ces) <- c('county', 'avg_pctl', 'avg_score')
```

### Create CA County Map and Overlay CES Score Data

What counties have the highest CES score?

```{r}
### counties data
ca_counties_sf <- ca_counties_raw_sf %>% 
  janitor::clean_names() %>%
  mutate(land_km2 = aland / 1e6) %>%
  select(county = name, land_km2)
#ca_counties_sf %>% st_crs() ###3857


### join the two together
county_ces_join <- merge(ca_county_ces, ca_counties_sf, by="county") %>% 
  select(-land_km2, -avg_pctl)

### ggplot
ces_plot <- ggplot(data = county_ces_join) +
  geom_sf(aes(fill = avg_score, geometry = geometry), color = "white", size = 0.1) +
  scale_fill_gradientn(colors = c("lightgray", "orange","red")) +
  theme_void() +
  labs(fill = "Average CES Score")

plot(ces_plot)
```

######################################## Water Quality + CES

### Groundwater Quality vs Poverty Score

Questions we want to ask: Is the poverty score a good indicator of water quality? compare using NLS

```{r}
# convert water quality to sf 
water_quality_sf <- st_as_sf(x = water_quality, 
                             coords = c('longitude', 'latitude'), 
                             crs = 4326)

water_quality_sf <- st_transform(water_quality_sf, 3857)


# combine water quality and county data 
county_water <- st_join(ca_counties_sf, water_quality_sf)

county_water_year <- county_water %>%
  drop_na() %>% 
  separate(date, c("year", "month", "day")) %>% 
  select(-month, -day, -land_km2) 

county_water_pivot <- county_water_year %>% 
  group_by(year, county, chemical) %>%
  summarize(mean_measurement = mean(measurement, na.rm = TRUE)) %>%
  pivot_wider(names_from = chemical, values_from = mean_measurement) %>% 
  janitor::clean_names()

# co3_plot <- ggplot(data = county_water_pivot) +
#   geom_sf(aes(fill = alkalinity_as_ca_co3, geometry = geometry), color = "white", size = 0.1) +
#   scale_fill_gradientn(colors = c("lightgray","orange","red")) +
#   theme_void() +
#   labs(fill = "Average CO3")
# 
# co3_plot
```

######################################### ShinyApp

### Attach necessary packages

```{r}
library(shiny)
library(tidyverse)
library(bslib)
```

### Create the user interface:

```{r}
ui <- fluidPage(
  theme = bs_theme(bootswatch = 'minty'),
  
  titlePanel('California Groundwater'),
  tabsetPanel(
    
    
    tabPanel( ### start tab 4
      title = 'Environmental Justice',
  
      fluidRow( # start fluid row 4.1
      column(width = 3,
                    h3('select demographic'),
                    radioButtons(
                      inputId = 'chemical_4_1',
                      label = 'demographic category',
                      choices = c('Poverty', 'Pollution', 'Cardiovascular Disease')
                    )
        ), ### end column
        column(width = 9,
                    h3('Map Here'),
                    plotOutput(outputId = 'ces_plot')
        )
      ), ### end fluidRow 4.1
      
      hr(), ### horizontal rule so the row breaks are easier to see
      p('talk about how they should look at the map'),
      hr(),
      
      fluidRow( # start fluid row 4.2
        column(
          width = 3,
          h3('Select other variable'),
          radioButtons(
            inputId = 'demographic',
            label = 'demographic category',
            choices = c(4, 6, 8)
          )
        ),
        column(
          width = 9,
          h3('Graph here'),
          #plotOutput('insert_graph'))
        )
      ) ### end fluidRow 4.2
      
    ) ### end tab 4 
  
  )
) # end Fluidpage

```

### Create the server function:

```{r}
server <- function(input, output) {
  
### START tab 4, row 1
  soc_select <- reactive({ ### start soc_select
    soc_df <- county_ces_join %>% 
      filter(chemical == input$chemical_4_1)
    
    return(soc_df)
  }) ### end soc_select
  
  
 output$ces_plot <- renderPlot({ ### start ces_plot
   ggplot(data = soc_select) +
    geom_sf(aes(fill = avg_score, geometry = geometry), color = "white", size = 0.1) +
    scale_fill_gradientn(colors = c("lightgray", "orange","red")) +
    theme_void() +
    labs(fill = "Average CES Score") 
  
 }) ### end ces_plot
### END tab 4, row 1
 
}
```

### Combine them into an app:

```{r}
shinyApp(ui = ui, server = server)
```

### Home Page

### Groundwater depth levels

### Chemicals

### Socioeconomic

### groundwater dependent ecosystems ?
