---
title: "Chelsea's Quarto"
author: "Chelsea Sanford"
format: html
editor: visual
---

```{r}
library(tidyverse)
library(here)
library(sf)
library(terra)
library(tidyterra)
library(dplyr)
```

### Load in the Data

```{r}
ca_counties_raw_sf <- read_sf(here("data/ca_counties/CA_Counties_TIGER2016.shp"))
socioeco_data <- read.csv(here('data/socioeco.csv'))
water_quality <- read_csv(here('data/water_quality.csv'))
```

############################################## CES + County Data

### Edit the CES data

```{r}
socio_by_county <- socioeco_data %>% 
  dplyr::group_by(california_county) %>% 
  summarize(total_pop = sum(total_population, na.rm = TRUE),
            ces = mean(ces_4_0_percentile, na.rm = TRUE),
            low_birth_weight = mean(low_birth_weight_pctl, na.rm = TRUE),
            cardio_disease = mean(cardiovascular_disease_pctl, na.rm = TRUE),
            education = mean(education_pctl, na.rm = TRUE),
            poverty = mean(poverty_pctl, na.rm = TRUE),
            unemployment = mean(unemployment_pctl, na.rm = TRUE))

socio_by_county$county <- socio_by_county$california_county 

socio_county <- socio_by_county %>% 
  select(-california_county) %>% 
  select(county, everything()) %>% 
  mutate(county = str_squish(county))
```

### Create CA County Map and Overlay CES Score Data

What counties have the highest CES score?

```{r}
### counties data
ca_counties_sf <- ca_counties_raw_sf %>% 
  janitor::clean_names() %>%
  mutate(land_km2 = aland / 1e6) %>%
  select(county = name, land_km2) %>% 
  mutate(county = str_squish(county)) 
#ca_counties_sf %>% st_crs() ###3857

### join the two together
county_socio_join <- merge(x = ca_counties_sf, y = socio_county, by = "county", all.x = TRUE) %>% 
  mutate(density = total_pop/land_km2) %>%
  select('county','density', everything(), -'total_pop', -'land_km2') %>%
  pivot_longer('density':'unemployment', names_to = 'parameter', values_to = 'percentile')

### ggplot
pop_plot <- ggplot(data = county_socio_join) +
  geom_sf(aes(fill = percentile, geometry = geometry), color = "white", size = 0.1) +
  scale_fill_gradientn(colors = c("lightgray", "orange","red")) +
  theme_void() +
  labs(fill = "Population Density")

# plot(pop_plot)
```

################################### Tab 4 Row 2 - Graphs #######################
```{r}
# ### START tab 2, row 2
#   
# gw_select_1 <- reactive({
#   gw_county_df_1 <- county_gw_avg_16 %>%
#     filter(county %in% input$county_2_2)
#   
#   return(gw_county_df_1)
# })  ### end gw_select_1
# 
# output$gw_plot_2 <- renderPlot({
#   ggplot(data = gw_select_1()) + 
#     geom_col(aes(x = year, y = average_depth)) + 
#     labs(x = "Year", 
#          y = "Average Groundwater Depth")
#     theme_minimal()
# })

### bar graph comparing counts by county
poverty_cardio_plot <- ggplot() +
  geom_col(data = county_socio_join, 
           aes(x = parameter, y = percentile))  +
        labs(x = 'Parameter', y = 'Percentile') +
        theme_minimal()

poverty_cardio_plot
```


######################################## Water Quality + CES ### 
Groundwater Quality vs Poverty Score
Questions we want to ask: Is the poverty score a good indicator of water quality? compare using NLS
```{r}
# # convert water quality to sf 
# water_quality_sf <- st_as_sf(x = water_quality, 
#                              coords = c('longitude', 'latitude'), 
#                              crs = 4326)
# 
# water_quality_sf <- st_transform(water_quality_sf, 3857)
# 
# 
# # combine water quality and county data 
# county_water <- st_join(ca_counties_sf, water_quality_sf)
# 
# county_water_year <- county_water %>%
#   drop_na() %>% 
#   separate(date, c("year", "month", "day")) %>% 
#   select(-month, -day, -land_km2) 
# 
# county_water_pivot <- county_water_year %>% 
#   group_by(year, county, chemical) %>%
#   summarize(mean_measurement = mean(measurement, na.rm = TRUE)) %>%
#   pivot_wider(names_from = chemical, values_from = mean_measurement) %>% 
#   janitor::clean_names()

# co3_plot <- ggplot(data = county_water_pivot) +
#   geom_sf(aes(fill = alkalinity_as_ca_co3, geometry = geometry), color = "white", size = 0.1) +
#   scale_fill_gradientn(colors = c("lightgray","orange","red")) +
#   theme_void() +
#   labs(fill = "Average CO3")
# 
# co3_plot
```

######################################### ShinyApp

### Attach necessary packages

```{r}
library(shiny)
library(tidyverse)
library(bslib)
```

### Create the user interface:

```{r}
# vector <- c('total_pop', 'ces', 'low_birth_weight', 'cardio_disease', 'education', 'poverty', 'unemplpoyment')

ui <- fluidPage(
  theme = bs_theme(bootswatch = 'minty'),
  
  titlePanel('California Groundwater'),
  tabsetPanel(
    
    
    tabPanel( ### start tab 4
      title = 'Environmental Justice',
      
      h4('Description:'), 
      p('This tab shows socioeconomic and health indicators mapped by percentile in each county. An indicator measures environmental conditions as well as health and vulnerability factors. The CalEnviroScreen indicators fall into four categories: exposure, environmental, sensitive population, and socioeconomic. Here, we have selected relevant sensitive population and socioeconomic indicators, which may be correlated with groundwater quality.'),
      hr(),
      fluidRow( # start fluid row 4.1
      column(width = 5,
                    h4('Socioeconomic Indicator'),
                    radioButtons(
                      inputId = 'factor_4_1',
                      label = ' ',
                      choices = c('Population Density' = 'density', 
                                  'CES Score' = 'ces', 
                                  'Low Birth Weight' = 'low_birth_weight', 
                                  'Cardiovascular Disease' = 'cardio_disease', 
                                  'Education' = 'education', 
                                  'Poverty' = 'poverty', 
                                  'Unemplpoyment' = 'unemployment')
                    )
        ), ### end column
        column(width = 7,
                    h4('Map of California Counties'),
                    plotOutput(outputId = 'pop_plot')
        )
      ), ### end fluidRow 4.1
      
      hr(), ### horizontal rule so the row breaks are easier to see
      p('talk about how they should look at the map'),
      hr(),
      
      fluidRow( # start fluid row 4.2
        column(
          width = 3,
          h3('Select other variable'),
          radioButtons(
            inputId = 'factor_4_2',
            label = 'demographic category',
            choices = c("Population Density" = 'density', 'CES Score' = 'ces', 
                                  'Low Birth Weight' = 'low_birth_weight', 
                                  'Cardiovascular Disease' = 'cardio_disease', 
                                  'Education' = 'education', 'Poverty' = 'poverty', 
                                  'Unemplpoyment' = 'unemployment')
          )
        ),
        column(
          width = 9,
          h3('Graph here'),
          #plotOutput('insert_graph'))
        )
      ) ### end fluidRow 4.2
      
    ) ### end tab 4 
  
  )
) # end Fluidpage
```

### Create the server function:

```{r}
server <- function(input, output) {
  
### START tab 4, row 1
  soc_select <- reactive({ ### start soc_select
    soc_df <- county_socio_join %>% 
      filter(parameter == input$factor_4_1)
    #select(geometry, tmp = all_of(input$demographics))
    
    return(soc_df)
  }) ### end soc_select
  
    output$pop_plot <- renderPlot({ ### start ces_plot
       ggplot(data = soc_select()) +
        geom_sf(aes(fill = percentile, geometry = geometry), color = "white", size = 0.1) +
        scale_fill_gradientn(colors = c("lightgray", "orange","red")) +
        theme_void() 
      
 }) ### end ces_plot
### END tab 4, row 1
    
### START tab 4, row 2
  soc_select_bar <- reactive({ ### start soc_select_bar
    soc_df_bar <- county_socio_join %>% 
      filter(county %in% input$factor_4_2)
    
    return(soc_df_bar)
  }) ### end soc_select
  
    output$poverty_cardio_plot <- renderPlot({ ### start poverty_cardio_plot
       ggplot(data = soc_select_bar()) +
        geom_col(aes(x = parameter, y = percentile)) +
        labs(x = 'Parameter', y = 'Percentile') +
        theme_minimal()
      
 }) ### end poverty_cardio_plot
    
### END tab 4, row 2
 
}
```

### Combine them into an app:

```{r}
shinyApp(ui = ui, server = server)
```

### Home Page

### Groundwater depth levels

### Chemicals

### Socioeconomic

### groundwater dependent ecosystems ?
